name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  APP_DIR: /opt/jurandir-finance

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate Prisma Client
        run: bun run db:generate

      - name: Run tests
        run: bun test

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          envs: APP_DIR
          script: |
            set -e

            cd $APP_DIR

            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main

            echo "ðŸ”„ Rebuilding and restarting..."
            docker compose down
            docker compose build --no-cache
            docker compose up -d

            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f

            echo "âœ… Deploy completed successfully!"
            docker compose ps
